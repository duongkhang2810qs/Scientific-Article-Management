//- 
//- File này cung cấp giao diện form chấm điểm và nhận xét đề tài nghiên cứu khoa học.
//- 
//- **Mục đích**:
//- 1. Cho phép nhập điểm cho từng tiêu chí đánh giá của một đề tài.
//- 2. Tính tổng số điểm tự động dựa trên các tiêu chí đã được chấm điểm.
//- 3. Gửi điểm số và nhận xét lên server khi nhấn nút "Lưu".
//- 
//- **Thành phần chính**:
//- 
//- 1. **Bảng tiêu chí chấm điểm**:
//-    - Các tiêu chí được nhóm thành các phần như: "Đặt vấn đề", "Mục tiêu đánh giá", "Phương pháp nghiên cứu", "Ý nghĩa thực tiễn", và "Hình thức trình bày".
//-    - Mỗi tiêu chí có cột "Điểm tối đa" và ô nhập liệu "Điểm chấm" với giá trị tối đa giới hạn bằng thuộc tính `max`.
//-    - Tổng số điểm được hiển thị ở cuối bảng trong ô `#totalScore`.
//- 
//- 2. **Phần nhận xét**:
//-    - Một trường `textarea` để nhập nhận xét về đề tài.
//- 
//- 3. **Nút hành động**:
//-    - Nút "Lưu": Gửi dữ liệu chấm điểm và nhận xét lên server thông qua API `axios`.
//-    - Nút "Hủy": Tải lại trang mà không lưu thay đổi.
//- 
//- **Chức năng chính**:
//- 
//- 1. **Tính toán tổng số điểm**:
//-    - Hàm `updateTotalScore` được gọi mỗi khi người dùng nhập hoặc thay đổi điểm chấm trong các ô nhập liệu.
//-    - Tự động giới hạn điểm nhập vượt quá `max` hoặc nhỏ hơn `min`.
//- 
//- 2. **Gửi dữ liệu**:
//-    - Dữ liệu gồm điểm tổng (`Diem`), nhận xét (`NhanXet`), và trạng thái (`TrangThai`) được gửi lên server qua API PATCH.
//- 
//- 3. **Giao diện người dùng**:
//-    - Thiết kế đơn giản, dễ sử dụng với các trường thông tin được hiển thị rõ ràng.
//-    - Các nút và chức năng đảm bảo tương tác mượt mà.
//- 
//- **Lợi ích**:
//- 1. Đơn giản hóa quy trình chấm điểm và nhận xét đề tài nghiên cứu khoa học.
//- 2. Tăng hiệu quả và giảm sai sót khi tính toán tổng điểm.
//- 3. Cải thiện trải nghiệm người dùng nhờ giao diện trực quan và tự động hóa.

form(id="form-diem")
    .card-body
        table.table.table-hover.table-condensed#list
            colgroup
                col(width="60%")
                col(width="10%")
                col(width="10%")

            thead
                tr
                    th.text-center Đánh giá
                    th.text-center Điểm tối đa
                    th.text-center Điểm chấm             
            tbody
                tr 
                    td.text-center
                        p 
                            b Đặt vấn đề  
                    td.text-center
                        b 20
                tr
                    td
                        p Đặt vấn đề ngắn gọn, nêu rõ vấn đề cần giải quyết, câu hỏi đánh giá, sự cần thiết, các nghiên cứu đánh giá khác liên quan.
                    td.text-center
                        p.truncate 10
                    td.text-center
                        input(type='number', name='score', min='0', max='10')

                tr
                    td
                        p Lý do tiến hành nghiên cứu đánh giá được trình bày thuyết phục.
                    td.text-center
                        p.truncate 10
                    td.text-center
                        input(type='number', name='score', min='0', max='10')

                tr 
                    td.text-center
                        p 
                            b Mục tiêu đánh giá
                    td.text-center
                        b 10
                tr
                    td
                        p Mục tiêu đánh giá vấn đề nghiên cứu rõ ràng.
                    td.text-center
                        p.truncate 5
                    td.text-center
                        input(type='number', name='score', min='0', max='5')

                tr
                    td
                        p Mục tiêu được viết thành câu rõ ràng.
                    td.text-center
                        p.truncate 5
                    td.text-center
                        input(type='number', name='score', min='0', max='5')

                tr 
                    td.text-center
                        p 
                            b Phương pháp nghiên cứu đánh giá
                    td.text-center
                        b 50
                tr
                    td
                        p Phương pháp nghiên cứu phù hợp.
                    td.text-center
                        p.truncate 10
                    td.text-center
                        input(type='number', name='score', min='0', max='10')

                tr
                    td
                        p Vấn đề đánh giá phù hợp.
                    td.text-center
                        p.truncate 10
                    td.text-center
                        input(type='number', name='score', min='0', max='10')

                tr
                    td
                        p Có khung lý thuyết phù hợp.
                    td.text-center
                        p.truncate 10
                    td.text-center
                        input(type='number', name='score', min='0', max='10')

                tr
                    td
                        p Bộ công cụ thu thập số liệu phù hợp với biến số, giả thuyết nghiên cứu và được trình bày hợp lý.
                    td.text-center
                        p.truncate 10
                    td.text-center
                        input(type='number', name='score', min='0', max='10')

                tr
                    td
                        p Phương pháp phân tích và xử lý số liệu hợp lý, khoa học và phù hợp với mục tiêu đánh giá.
                    td.text-center
                        p.truncate 10
                    td.text-center
                        input(type='number', name='score', min='0', max='10')

                tr 
                    td.text-center
                        p 
                            b Ý nghĩa thực tiễn và tính sáng tạo của đề tài.
                    td.text-center
                        b 10
                tr
                    td
                        p Đề tài có tính thời sự, có ý nghĩa trong thực tiễn.
                    td.text-center
                        p.truncate 5
                    td.text-center
                        input(type='number', name='score', min='0', max='5')

                tr
                    td
                        p Có tính sáng tạo, đóng góp mới cho lĩnh vực đánh giá.
                    td.text-center
                        p.truncate 5
                    td.text-center
                        input(type='number', name='score', min='0', max='5')

                tr 
                    td.text-center
                        p 
                            b Hình thức trình bày
                    td.text-center
                        b 10
                tr
                    td
                        p Lỗi chính tả, cú pháp, trình bày khoa học, súc tích, rõ ràng, dễ hiểu.
                    td.text-center
                        p.truncate 10
                    td.text-center
                        input(type='number', name='score', min='0', max='10')

                tr
                    td.text-center 
                        b Tổng số điểm
                    td
                    td.text-center#totalScore 0

        b Nhận xét      
        textarea(id='comment', name='comment', rows='4', cols='50', style='width:100%')

        .col-lg-12.text-right.justify-content-center.d-flex
            button.btn.btn-primary.mr-2(type="button", id='saveButton') Lưu
            button.btn.btn-secondary(type="button", id='cancelButton') Cancel

script.
    const scoreInputs = document.querySelectorAll('input[name="score"]');
    const totalScoreElement = document.getElementById('totalScore');

    function updateTotalScore() {
        let totalScore = 0;
        scoreInputs.forEach(input => {
            const max = parseInt(input.max, 10);
            const min = parseInt(input.min, 10);

            if (parseInt(input.value, 10) > max) input.value = max;
            if (parseInt(input.value, 10) < min || input.value === "") input.value = min;

            totalScore += Number(input.value);
        });
        totalScoreElement.textContent = totalScore;
    }

    scoreInputs.forEach(input => {
        input.addEventListener('input', updateTotalScore);
    });

    document.getElementById('saveButton').addEventListener('click', function () {
        const id = window.location.pathname.split('/')[2];
        const score = parseFloat(totalScoreElement.textContent);
        const comment = document.getElementById('comment').value;

        axios.patch(`/api/v1/topics/${id}`, { Diem: score, NhanXet: comment, TrangThai: 'hoàn thành' })
            .then(() => {
                alert("Cập nhật thành công!");
                window.location.href = `/topics`;
            })
            .catch((error) => {
                console.error('Error:', error);
                alert("Có lỗi xảy ra khi lưu dữ liệu.");
            });
    });

    document.getElementById('cancelButton').addEventListener('click', function () {
        window.location.reload();
    });
